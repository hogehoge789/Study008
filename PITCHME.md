## 暗号化技術の変革の時

クライアント(または、ユーザー)とサーバーの間であるネットワーク経路上において、大規模な監視が行われている実態について
様々な憶測が飛び交う。

スノーデン事件を皮切り

米国家安全保障局（NSA）がテロ対策として極秘に大量の個人情報を収集していたことを、
元NSA外部契約社員のエドワード・スノーデンが暴露し、物議をかもした事件。

ネットワークを信頼して良いのか、
ネットワークへの信頼が揺らいでしまった

---

* 完全なるネットワークの暗号化の動きが出てきた

DNS → DNS over HTTPS
TCP → QUIC
TLS1.2 → TLS1.3

---

## 暗号化通信で主要なTLSの問題点
* ハンドシェイクによるRTTが長い
* ハンドシェイクが平文なので証明書の中身が見える

---

### TLS1.3

* 実質、メジャーバージョンアップと言われる程の改修
* 0-1 RTTハンドシェイク
* AEAD ciphersを使う
* forward securityが要件として入った
* セッションチケットを使いまわさない

---

### 0-1 RTTハンドシェイク

TLS1.2まではClient Helloを起点にパラメータ交換を実施し、
その後に鍵の交換を経て通信暗号化がなされる

この方式だと暗号化までに2回の通信が発生する

どこと通信されるかは暗号化されていない
ここから追跡される事例があった


TLS1.3では最初のClient Helloから公開鍵暗号を使って暗号化されている

---

### TLS1.3において発生した過去の問題

Enterprise向けのFWなどがTLS1.3をうまく理解しなかった
証明書が暗号化される事を不審な挙動と判定してしまう
* 従来のFWでは証明書の中身を見てどこと通信しているか見ていたのだが、それが暗号化されてしまっていたのが理由

---

### セキュリティ3原則

* 機密性(confideniality)
* 完全性(integrity)
* 可用性(availability)

TLSは機密性と完全性は担保するが、可用性はTCPに依存している

ファイアーウォール等がTCPレベルで切断ができてしまう

---

on-path attack
man-on-the-side attack
off-path attack

現状のTLSではman-on-the-side attackが容易にできてしまう
DTLSやIPsecなどは耐性がある

---

## QUICプロトコル


---

## QUICの特徴
* TLS1.3を使った暗号化通信
* 0-1RTハンドシェイク
QUIC Cryptoという独自の暗号化方式があったが、TLS1.3に置き換えられている

* 複数のストリームを1コネクションにまとめる multiplexing streams 
* HTTP2(というよりTCP)の問題であるパケットの順番が保証されていないと読み込めない配信方式が改善されて高速な通信が見込める
→ヘッドオブラインブロッキングが解消されている
* モビリティ
** 通信毎に固有のIDを保持
** 無線通信やモバイルで強い
** QUICでは4タプルに依存しないコネクションが確保される

---

QUIC+TLSで2重の暗号化がかかってしまう

各々、フローが異なるので信頼するタイミングがズレがあるので
暗号化通信をいつ始めていいかわからない、対応が難しい

TLS上は暗号化されていても、QUICは暗号化されていなくて平文なので
平文で通信している間は当然ながらパケット挿入可能(ACK、RST)
→TLSプロトコルを変更した

TLSのレイヤで行っていた暗号化の仕事を全てQUIC上で行う。
QUIC+TLSで5層構造
→TLS recordレイヤがなくなり、4層構造になった
QUIC packetレイヤで処理する

TLSは鍵交換と相手の認証
QUICが暗号化

結果、1RTTで暗号化が完結する流れとなった
→注入攻撃に対応

---

コネクションID？
パケット番号？

コネクションIDが切り替わった瞬間のパケット番号がわかるとその瞬間がバレてしまう

パケット番号も暗号化する事に(PNE)

パケット番号の暗号化：
AES_GCM(PN, payload)→ciphertext+AEAD_TAG, AES_CTR(ciphertext, PN)→PNE
※AES_CTRのnonceにchipertextの先頭使う

明示的に決められた情報だけが平文で通信される 

---

QUICはTCPを使用しないので逆順でも再送要求が発生しない
そもそも、パケット番号が暗号化されているのでそもそも再送要求ができない

TCPの場合、携帯電話の基地局はパケットの順序がずれたときのために再送を減らすために通信をバッファリングしている。
効果は5％くらいある。

ただし、QUICではパケット番号を暗号化するのでバッファリングの意味がなくなる。

---
QUICではTLSがハンドシェイク、QUICが暗号化
ほとんどすべての通信が暗号化される(完全にすべてではない))




---

Encrypted SNI
SNIの暗号化





---